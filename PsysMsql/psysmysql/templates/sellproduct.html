{% extends "base.html" %}
{% load currency_filters %}
<title>{% block title %}Sell-product{% endblock %}</title>
{% block content %}
<nav class="mx-10 my-5 text-black p-3 absolute top-0 right-30 text-xm">
  <a href="{% url 'list-product' %}">Productos/</a>
  <a href="{% url 'register_product' %}">Registrar productos/</a>
  <a href="{% url 'delete-product' %}">Eliminar productos/</a>
  <a href="{% url 'update-product' %}">Actualizar productos/</a>
  <a href="{% url 'stock_products' %}">stock/</a>
  <a href="{% url 'main' %}">home<a />
</nav>
<section class="flex flex-col items-center">
  <form class="flex flex-row items-center my-15" method="post">
    {% csrf_token %}
    {{ formsell }}
    <button id="sell" name="sell" type="submit" class="text-xm text-white bg-green-500 rounded-3xl w-15 p-2"><i
        class="fa-solid fa-plus"></i></button>
  </form>
</section>
<div class="flex flex-col items-center">
  <section class="flex flex-row items-center mx-5 mb-10 text-black bg-white p-2 w-[fit-content]">
  <aside class="h-[fit-content] w-[fit-content] bg-white p-2 mb-10  max-h-40 overflow-y-auto">
    {% include "listsellproducts.html" %}
  </aside>
  <ul class="flex flex-col bg-white text-black text-xm font-extalight w-[fit-content] mx-10">
      <li class="bg-gray-100 my-1 p-1">Cantidad total: {{ quantity }}</li>
      <li class="bg-gray-100 my-1 p-1">Iva 19%: {{ iva_calculated|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Subtotal: {{ price_iva|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Precio total: {{ price_x_quantity|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Pago: {{ quantity_pay|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Cambio: {{ money_back|format_currency_cop}}</li>
  </ul>
</section>
</div>
<section class="bg-white grid grid-cols-2 items-center justify-items-center gap-4 p-1 mx-5 mb-10">
  <form method="post" class="my-20 flex flex-row space-x-1 justify-items-center items-center rounded-2xl">
    {% csrf_token %} {{ formregsitersell }}
    <button id="add" name="add" type="submit"
      class="bg-green-500  text-xm text-white rounded-3xl p-2">agregar</button>
  </form>
  <div class="flex flex-col my-5 text-xm text-black font-extralight p-1">
    <form method="post" class="grid grid-cols-2 grid-rows-1 gap-2 item justify-items-center">
      {% csrf_token %}
      {{ sentform }}
      <div class="form-group">
        <label for="id_client_email_selected">Correo para envío de confirmación de venta:</label>
        <input type="email" id="id_client_email_selected" name="client_email_selected"
          placeholder="ejemplo@dominio.com" readonly class="italic font-extrabold">
      </div>
      <button id="sent" name="sent" type="submit"
        class="bg-green-500 p-2 text-xm text-white rounded-2xl mb-10">enviar</button>
    </form>
    <div class="section">
      <h2>Búsqueda de Clientes(Correo)</h2>
      <form action="" method="GET" class="search-form-inline">
        <div class="form-group">
          <label for="{{ formsearch.query.id_for_label }}">Correo:</label>
          {{ formsearch.query }}
          {% if formsearch.query.help_text %}<small>{{ formsearch.query.help_text }}</small>{% endif %}
          {% for error in formsearch.query.errors %}<span style="color: red;">{{ error }}</span>{% endfor %}
        </div>
        <button type="submit" class="bg-green-500 text-white font-medium p-2 rounded-2xl my-5">Buscar</button>
      </form>
      <div class="search-results">
        {% if search_query %}
        <h3>Resultados para "{{ search_query }}"</h3>
        {% if search_results %}
        {% for client in search_results %}
        <div class="client-item">
          <p>Correo <span class="client-email-copy font-extrabold" data-email="{{ client.email }}"
              style="cursor: pointer; text-decoration: underline; color: white;">{{ client.email }}</span></p>
          {% if client.name %}<p>Nombre: {{ client.name }}</p>{% endif %}
          {% if client.telephone %}<p>Teléfono: {{ client.telephone }}</p>{% endif %}
          {% if client.direction %}<p>Dirección: {{ client.direction }}</p>{% endif %}
          {% if client.nit %}<p>Nit: {{ client.nit }}</p>{% endif %}
          {% if client.country %}<p>País: {{ client.country }}</p>{% endif %}
          {% if client.departament %}<p>Departamento: {{ client.departament }}</p>{% endif %}
          {% if client.city %}<p>Ciudad: {{ client.city }}</p>{% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p class="no-results">No se encontraron clientes con el correo "{{ search_query }}".</p>
        {% endif %}
        {% else %}
        <p class="no-results">Usa la barra de búsqueda para encontrar clientes por correo electrónico.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% if messages %}
<div id="messages" class="bg-green-500 text-xm text-white absolute bottom-25 right-10 rounded-2xl  p-5">
  <ul class="messages">
    {% for message in messages %}
    <span class="{{ message.tag}}">{{message}}</span>
    {% endfor %}
  </ul>
</div>
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const temporalMessage = document.getElementById('messages');
    if (temporalMessage) {
      // Show the message "Producto guarado con exito", for 10 seconds.
      setTimeout(function () {
        temporalMessage.style.display = 'none'
      }, 10000);
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    console.log("¡DOMContentLoaded se ha disparado!"); // Confirma que el script se está ejecutando

    const emailSpans = document.querySelectorAll('.client-email-copy');
    console.log("Elementos .client-email-copy encontrados:", emailSpans.length, emailSpans); // ¿Encuentra los elementos clickeables?

    const selectedEmailInput = document.getElementById('id_client_email_selected');
    console.log("Campo visible 'id_client_email_selected' encontrado:", selectedEmailInput); // ¿Encuentra el campo visible?

    const hiddenEmailInput = document.getElementById('id_client_email_selected');
    console.log("Campo oculto 'hidden_client_email_selected' encontrado:", hiddenEmailInput); // ¡ESTE ES EL CLAVE!

    if (hiddenEmailInput === null) {
      console.error("⛔️ ERROR: hiddenEmailInput es NULL. El elemento con ID 'hidden_client_email_selected' NO fue encontrado en el DOM.");
    } else {
      console.log("✅ hiddenEmailInput encontrado. ¡Todo bien para manipularlo!");
    }

    emailSpans.forEach(span => {
      span.addEventListener('click', function () {
        const email = this.dataset.email;
        console.log("Se hizo clic en el correo:", email); // ¿El evento click se dispara?
        if (selectedEmailInput) { // Añadimos una comprobación por si selectedEmailInput también fuera null
          selectedEmailInput.value = email;
          console.log("Valor del campo visible actualizado a:", selectedEmailInput.value);
        }
        if (hiddenEmailInput) { // Añadimos una comprobación para evitar el error si es null
          hiddenEmailInput.value = email;
          console.log("Valor del campo OCULTO actualizado a:", hiddenEmailInput.value);
        } else {
          console.warn("Advertencia: No se pudo actualizar hiddenEmailInput porque es null.");
        }
      });
    });
  });
</script>
{% endblock %}
