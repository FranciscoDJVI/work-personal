{% extends "base.html" %}
{% load currency_filters %}
{% load static %}
<title>{% block title %}Sell-product{% endblock %}</title>
{% block content %}
<nav class="mx-10 my-5 text-black p-3 absolute top-0 right-30 text-xm">
  <a href="{% url 'list-product' %}">Productos/</a>
  <a href="{% url 'register_product' %}">Registrar productos/</a>
  <a href="{% url 'delete-product' %}">Eliminar productos/</a>
  <a href="{% url 'update-product' %}">Actualizar productos/</a>
  <a href="{% url 'stock_products' %}">stock/</a>
  <a href="{% url 'main' %}">home<a />
</nav>
<section class="flex flex-col items-center">
  <form id="sell-form" class="flex flex-row items-center my-15" method="post">
    {% csrf_token %}
    
    <!-- Campo de búsqueda de productos -->
    <div class="relative">
      {{ formsell.product_search }}
      <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-b-md shadow-lg hidden max-h-48 overflow-y-auto">
        <!-- Los resultados de la búsqueda aparecerán aquí -->
      </div>
    </div>
    
    <!-- Campo oculto para el ID del producto seleccionado -->
    {{ formsell.id_product }}
    
    <!-- Campo de cantidad -->
    {{ formsell.totalsell }}
    
    <button id="sell" name="sell" type="submit" class="text-xm text-white bg-green-500 rounded-3xl w-15 p-2"><i
        class="fa-solid fa-plus"></i></button>
  </form>
</section>
<div class="flex flex-col items-center">
  <section class="flex flex-row items-center mx-5 mb-10 text-black bg-white p-2 w-[fit-content]">
  <aside class="h-[fit-content] w-[fit-content] bg-white p-2 mb-10  max-h-40 overflow-y-auto">
    {% include "listsellproducts.html" %}
  </aside>
  <ul class="flex flex-col bg-white text-black text-xm font-extalight w-[fit-content] mx-10">
      <li class="bg-gray-100 my-1 p-1">Cantidad total: {{ quantity }}</li>
      <li class="bg-gray-100 my-1 p-1">Iva 19%: {{ iva_calculated|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Subtotal: {{ price_iva|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Precio total: {{ price_x_quantity|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Pago: {{ quantity_pay|format_currency_cop}}</li>
      <li class="bg-gray-100 my-1 p-1">Cambio: {{ money_back|format_currency_cop}}</li>
  </ul>
</section>
</div>
<section class="bg-white grid grid-cols-2 items-center justify-items-center gap-4 p-1 mx-5 mb-10">
  <form method="post" class="my-20 flex flex-row space-x-1 justify-items-center items-center rounded-2xl">
    {% csrf_token %} {{ formregsitersell }}
    <button id="add" name="add" type="submit"
      class="bg-green-500  text-xm text-white rounded-3xl p-2">agregar</button>
  </form>
  <div class="flex flex-col my-5 text-xm text-black font-extralight p-1">
    <form method="post" class="grid grid-cols-2 grid-rows-1 gap-2 item justify-items-center">
      {% csrf_token %}
      {{ sentform }}
      <div class="form-group">
        <label for="id_client_email_selected">Correo para envío de confirmación de venta:</label>
        <input type="email" id="id_client_email_selected" name="client_email_selected"
          placeholder="ejemplo@dominio.com" readonly class="italic font-extrabold">
      </div>
      <button id="sent" name="sent" type="submit"
        class="bg-green-500 p-2 text-xm text-white rounded-2xl mb-10">enviar</button>
    </form>
    <div class="section">
      <h2>Búsqueda de Clientes(Correo)</h2>
      <form action="" method="GET" class="search-form-inline">
        <div class="form-group">
          <label for="{{ formsearch.query.id_for_label }}">Correo:</label>
          {{ formsearch.query }}
          {% if formsearch.query.help_text %}<small>{{ formsearch.query.help_text }}</small>{% endif %}
          {% for error in formsearch.query.errors %}<span style="color: red;">{{ error }}</span>{% endfor %}
        </div>
        <button type="submit" class="bg-green-500 text-white font-medium p-2 rounded-2xl my-5">Buscar</button>
      </form>
      <div class="search-results">
        {% if search_query %}
        <h3>Resultados para "{{ search_query }}"</h3>
        {% if search_results %}
        {% for client in search_results %}
        <div class="client-item">
          <p>Correo <span class="client-email-copy font-extrabold" data-email="{{ client.email }}"
              style="cursor: pointer; text-decoration: underline; color: white;">{{ client.email }}</span></p>
          {% if client.name %}<p>Nombre: {{ client.name }}</p>{% endif %}
          {% if client.telephone %}<p>Teléfono: {{ client.telephone }}</p>{% endif %}
          {% if client.direction %}<p>Dirección: {{ client.direction }}</p>{% endif %}
          {% if client.nit %}<p>Nit: {{ client.nit }}</p>{% endif %}
          {% if client.country %}<p>País: {{ client.country }}</p>{% endif %}
          {% if client.departament %}<p>Departamento: {{ client.departament }}</p>{% endif %}
          {% if client.city %}<p>Ciudad: {{ client.city }}</p>{% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p class="no-results">No se encontraron clientes con el correo "{{ search_query }}".</p>
        {% endif %}
        {% else %}
        <p class="no-results">Usa la barra de búsqueda para encontrar clientes por correo electrónico.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% if messages %}
<div id="messages" class="bg-green-500 text-xm text-white absolute bottom-25 right-10 rounded-2xl  p-5">
  <ul class="messages">
    {% for message in messages %}
    <span class="{{ message.tag}}">{{message}}</span>
    {% endfor %}
  </ul>
</div>
{% endif %}
<!-- Script de búsqueda de productos inline para compatibilidad máxima -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Ocultar mensajes después de 10 segundos
    var temporalMessage = document.getElementById('messages');
    if (temporalMessage) {
      setTimeout(function () {
        temporalMessage.style.display = 'none';
      }, 10000);
    }

    // ===== FUNCIONALIDAD PARA BÚSQUEDA DE PRODUCTOS =====
    var productSearchInput = document.getElementById('product-search-input');
    var searchResults = document.getElementById('search-results');
    var selectedProductIdInput = document.getElementById('selected-product-id');
    var searchTimeout;
    var currentSelectedIndex = -1;
    var availableProducts = [];

    if (productSearchInput && searchResults && selectedProductIdInput) {
      // Evento de input para búsqueda
      productSearchInput.addEventListener('input', function(event) {
        var query = event.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
          searchTimeout = setTimeout(function() {
            searchProducts(query);
          }, 300);
        } else {
          hideResults();
          resetSelection();
        }
      });

      // Navegación con teclado
      productSearchInput.addEventListener('keydown', function(event) {
        var resultItems = searchResults.querySelectorAll('.result-item');
        
        switch(event.key) {
          case 'ArrowDown':
            event.preventDefault();
            if (resultItems.length > 0) {
              currentSelectedIndex = Math.min(currentSelectedIndex + 1, resultItems.length - 1);
              updateSelection(resultItems);
            }
            break;
            
          case 'ArrowUp':
            event.preventDefault();
            if (resultItems.length > 0) {
              currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
              updateSelection(resultItems);
            }
            break;
            
          case 'Enter':
            event.preventDefault();
            if (currentSelectedIndex >= 0 && currentSelectedIndex < availableProducts.length) {
              selectProduct(availableProducts[currentSelectedIndex]);
            } else if (availableProducts.length === 1) {
              selectProduct(availableProducts[0]);
            }
            break;
            
          case 'Escape':
            event.preventDefault();
            hideResults();
            resetSelection();
            break;
        }
      });

      // Ocultar al hacer clic fuera
      document.addEventListener('click', function(event) {
        if (!productSearchInput.contains(event.target) && !searchResults.contains(event.target)) {
          hideResults();
          resetSelection();
        }
      });
    }

    function searchProducts(query) {
      var url = '{% url "search_products_ajax" %}?q=' + encodeURIComponent(query);
      
      fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(function(response) {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        console.log('Search results:', data);
        if (data.results) {
          displayResults(data.results);
        } else {
          hideResults();
        }
      })
      .catch(function(error) {
        console.error('Error:', error);
        showError(error.message);
      });
    }

    function displayResults(results) {
      searchResults.innerHTML = '';
      availableProducts = results;
      resetSelection();
      
      if (results.length === 0) {
        showNoResults();
        return;
      }

      for (var i = 0; i < results.length; i++) {
        var product = results[i];
        var resultItem = document.createElement('div');
        resultItem.className = 'result-item p-2 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
        resultItem.setAttribute('data-index', i);
        
        resultItem.innerHTML = 
          '<div class="font-medium text-black">' + escapeHtml(product.name) + '</div>' +
          '<div class="text-sm text-gray-600">Precio: $' + parseFloat(product.price).toLocaleString('es-CO') + '</div>';
        
        // Click event
        (function(prod) {
          resultItem.addEventListener('click', function() {
            selectProduct(prod);
          });
        })(product);
        
        // Mouse enter event
        (function(index) {
          resultItem.addEventListener('mouseenter', function() {
            currentSelectedIndex = index;
            updateSelection(searchResults.querySelectorAll('.result-item'));
          });
        })(i);
        
        searchResults.appendChild(resultItem);
      }
      
      showResults();
    }

    function selectProduct(product) {
      productSearchInput.value = product.name;
      selectedProductIdInput.value = product.id;
      hideResults();
      resetSelection();
      
      // Enfocar campo de cantidad
      var quantityInput = document.querySelector('input[name="totalsell"]');
      if (quantityInput) {
        setTimeout(function() {
          quantityInput.focus();
        }, 100);
      }
      
      console.log('Producto seleccionado:', product.name, 'ID:', product.id);
    }

    function showNoResults() {
      var noResultsDiv = document.createElement('div');
      noResultsDiv.className = 'p-2 text-gray-500';
      noResultsDiv.textContent = 'No se encontraron productos';
      searchResults.appendChild(noResultsDiv);
      showResults();
    }

    function showError(message) {
      searchResults.innerHTML = '';
      var errorDiv = document.createElement('div');
      errorDiv.className = 'p-2 text-red-500';
      errorDiv.textContent = 'Error: ' + message;
      searchResults.appendChild(errorDiv);
      showResults();
      
      setTimeout(function() {
        hideResults();
      }, 3000);
    }

    function updateSelection(resultItems) {
      for (var i = 0; i < resultItems.length; i++) {
        resultItems[i].classList.remove('bg-blue-100');
      }
      
      if (currentSelectedIndex >= 0 && currentSelectedIndex < resultItems.length) {
        resultItems[currentSelectedIndex].classList.add('bg-blue-100');
        resultItems[currentSelectedIndex].scrollIntoView({
          behavior: 'smooth',
          block: 'nearest'
        });
      }
    }

    function resetSelection() {
      currentSelectedIndex = -1;
    }

    function showResults() {
      searchResults.classList.remove('hidden');
    }

    function hideResults() {
      searchResults.classList.add('hidden');
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== FUNCIONALIDAD PARA EMAILS DE CLIENTES =====
    var emailSpans = document.querySelectorAll('.client-email-copy');
    var selectedEmailInput = document.getElementById('id_client_email_selected');

    for (var i = 0; i < emailSpans.length; i++) {
      emailSpans[i].addEventListener('click', function () {
        var email = this.dataset.email;
        if (selectedEmailInput) {
          selectedEmailInput.value = email;
          console.log("Correo seleccionado:", email);
        }
      });
    }

    // ===== VALIDACIÓN DEL FORMULARIO DE VENTA =====
    var sellForm = document.getElementById('sell-form');
    if (sellForm) {
      sellForm.addEventListener('submit', function(e) {
        var productId = selectedProductIdInput.value;
        var quantity = document.querySelector('input[name="totalsell"]').value;
        
        if (!productId) {
          e.preventDefault();
          alert('Por favor, selecciona un producto de la lista.');
          productSearchInput.focus();
          return false;
        }
        
        if (!quantity || quantity <= 0) {
          e.preventDefault();
          alert('Por favor, ingresa una cantidad válida.');
          document.querySelector('input[name="totalsell"]').focus();
          return false;
        }
      });
    }
  });
</script>
{% endblock %}
