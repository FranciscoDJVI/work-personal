{% extends "base.html" %}
{% load currency_filters %}
{% load static %}
<title>{% block title %}Sell-product{% endblock %}</title>
{% block content %}
<nav class="mx-10 my-5 text-black p-3 absolute top-0 right-30 text-xm">
  <a href="{% url 'list-product' %}">Productos/</a>
  <a href="{% url 'list_all_sell_register' %}">Registros de venta/</a>
  <a href="{% url 'register_product' %}">Registrar productos/</a>
  <a href="{% url 'delete-product' %}">Eliminar/</a>
  <a href="{% url 'update-product' %}">Actualizar/</a>
  <a href="{% url 'stock_products' %}">stock/</a>
  <a href="{% url 'main' %}">home</a>
</nav>
<section class="flex flex-col flex-wrap items-center">
  <form id="sell-form" class="flex flex-row items-center my-15" method="post">
    {% csrf_token %}
    
    <!-- Campo de búsqueda de productos -->
    <div class="relative">
      {{ formsell.product_search }}
      <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-b-md shadow-lg hidden max-h-48 overflow-y-auto">
        <!-- Los resultados de la búsqueda aparecerán aquí -->
      </div>
    </div>
    
    <!-- Campo oculto para el ID del producto seleccionado -->
    {{ formsell.id_product }}
    
    <!-- Campo de cantidad -->
    {{ formsell.totalsell }}
    
    <button id="sell" name="sell" type="submit" class="text-xm text-white bg-green-500 w-15 p-2"><i
        class="fa-solid fa-plus"></i></button>
  </form>
</section>
<div class="flex justify-center items-center gap-4 bg-white mx-5 mb-10 p-2">
  <section class="flex p-2 mb-10  ">
    <aside class="h-[fit-content] w-[fit-content] p-2 mb-10 max-h-40 overflow-y-auto">
      {% include "listsellproducts.html" %}
    </aside>
      <aside class='w-[fit-content]'>
          <ul class="border border-gray-300 text-2xl font-extralight p-2">
              <li>Cantidad: {{ totals.quantity}}</li>
              <li>Iva: {{ totals.iva}}</li>
              <li>Subtotal: {{totals.subtotal|format_currency_cop}}</li>
              <li>Total: {{totals.total_sell|format_currency_cop}}</li>
          </ul>
      </aside>
  </section>
</div>
<section class="flex flex-row flex-wrap bg-white justify-center items-center mx-5 mb-5 gap-4 ">
  <form method="post" class="flex flex-row flex-wrap justify-center items-center gap-4 my-5 mx-5">
    {% csrf_token %}
    {{ formregsitersell }}
    <button id="add" name="add" type="submit"
      class="bg-green-500  text-xm text-white p-2 font-extrabold">Agregar</button>
    <aside class="bg-gray-200 flex flex-col flex-wrap my-5 mx-5 items-center justify-between border border-gray-300 p-5 text-2xl">
        <h3 class="text-green-500 font-medium">Pago: {{change.quantity_pay|format_currency_cop}}</h3>
        <h3 class="text-red-600 font-medium">Cambio: {{change.change|format_currency_cop}}</h3>
      </aside>
  </form>
    <div class="flex flex-col flex-wrap  my-5 text-xm text-black font-extralight p-1 ">
    <form method="post" class="flex">
      {% csrf_token %}
      {{ sentform }}
      <div class="form-group">
        <label for="id_client_email_selected">Correo-confirmación de venta:</label>
        <input type="email" id="id_client_email_selected" name="client_email_selected"
          placeholder="ejemplo@dominio.com" readonly class="italic font-extrabold">
      </div>
      <button id="sent" name="sent" type="submit"
        class="bg-green-500 p-2 text-xm text-white mb-10 font-extrabold">Enviar</button>
    </form>
    <div class="section">
      <h2>Búsqueda de Clientes(Correo)</h2>
      <form action="" method="GET" class="search-form-inline">
        <div class="form-group">
          <label for="{{ formsearch.query.id_for_label }}">Correo:</label>
          {{ formsearch.query }}
          {% if formsearch.query.help_text %}<small>{{ formsearch.query.help_text }}</small>{% endif %}
          {% for error in formsearch.query.errors %}<span style="color: red;">{{ error }}</span>{% endfor %}
        </div>
        <button type="submit" class="bg-green-500 text-white font-extrabold p-2 my-5" id="search_gmail" name="search_gmail">Buscar</button>
      </form>
      <div class="search-results">
        {% if search_query %}
        <h3>Resultados para "{{ search_query }}"</h3>
        {% if search_results %}
        {% for client in search_results %}
        <div class="client-item">
          <p>Correo <span class="client-email-copy font-extrabold" data-email="{{ client.email }}"
              style="cursor: pointer; text-decoration: underline; color: black;">{{ client.email }}</span></p>
          {% if client.name %}<p>Nombre: {{ client.name }}</p>{% endif %}
          {% if client.telephone %}<p>Teléfono: {{client.telephone}}</p>{% endif %}
          {% if client.direction %}<p>Dirección: {{client.direction}}</p>{% endif %}
          {% if client.nit %}<p>Nit: {{ client.nit }}</p>{% endif %}
          {% if client.country %}<p>País: {{ client.country }}</p>{% endif %}
          {% if client.departament %}<p>Departamento: {{ client.departament }}</p>{% endif %}
          {% if client.city %}<p>Ciudad: {{ client.city }}</p>{% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p class="no-results">No se encontraron clientes con el correo "{{search_query}}".</p>
        {% endif %}
        {% else %}
        <p class="no-results">Usa la barra de búsqueda para encontrar clientes por correo electrónico.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% if messages %}
<div id="messages" class="bg-green-500 text-xm text-white absolute bottom-25 right-10 rounded-2xl  p-5">
  <ul class="messages">
    {% for message in messages %}
    <li class="{{ message.tag}}">{{message}}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}
<!-- Funcionalidad específica de la página -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Ocultar mensajes después de 10 segundos
    var temporalMessage = document.getElementById('messages');
    if (temporalMessage) {
      setTimeout(function () {
        temporalMessage.style.display = 'none';
      }, 10000);
    }

    // ===== INICIALIZAR BÚSQUEDA DE PRODUCTOS =====
    if (window.ProductSearch) {
      window.productSearchInstance = new ProductSearch({
        searchUrl: '{% url "search_products_ajax" %}'
      });
    }

    // ===== FUNCIONALIDAD PARA EMAILS DE CLIENTES =====
    var emailSpans = document.querySelectorAll('.client-email-copy');
    var selectedEmailInput = document.getElementById('id_client_email_selected');

    for (var i = 0; i < emailSpans.length; i++) {
      emailSpans[i].addEventListener('click', function () {
        var email = this.dataset.email;
        if (selectedEmailInput) {
          selectedEmailInput.value = email;
          console.log("Correo seleccionado:", email);
        }
      });
    }

    // ===== VALIDACIÓN DEL FORMULARIO DE VENTA =====
    var sellForm = document.getElementById('sell-form');
    if (sellForm) {
      sellForm.addEventListener('submit', function(e) {
        var selectedProductInput = document.getElementById('selected-product-id');
        var productId = selectedProductInput ? selectedProductInput.value : '';
        var quantity = document.querySelector('input[name="totalsell"]').value;
        
        if (!productId) {
          e.preventDefault();
          alert('Por favor, selecciona un producto de la lista.');
          var productSearchInput = document.getElementById('product-search-input');
          if (productSearchInput) productSearchInput.focus();
          return false;
        }
        
        if (!quantity || quantity <= 0) {
          e.preventDefault();
          alert('Por favor, ingresa una cantidad válida.');
          document.querySelector('input[name="totalsell"]').focus();
          return false;
        }
      });
    }
  });
</script>
{% endblock %}
